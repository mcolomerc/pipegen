#!/bin/bash
# Pre-push hook to run comprehensive checks before pushing to main

set -e

protected_branch="main"
current_branch=$(git rev-parse --abbrev-ref HEAD)

echo "ğŸš€ Pre-push hook: Checking branch '$current_branch'"

# Only run checks when pushing to main
if [ "$current_branch" = "$protected_branch" ]; then
    echo "ğŸ”’ Pushing to protected branch '$protected_branch' - running comprehensive checks..."
    
    # Run golangci-lint
    echo "ğŸ” Running golangci-lint..."
    if ! golangci-lint run --timeout=10m; then
        echo "âŒ golangci-lint failed. Push aborted."
        exit 1
    fi
    echo "âœ… golangci-lint passed!"
    
    # Run tests
    echo "ğŸ§ª Running tests..."
    if ! go test -v -race ./...; then
        echo "âŒ Tests failed. Push aborted."
        exit 1
    fi
    echo "âœ… Tests passed!"
    
    # Build check
    echo "ğŸ”¨ Running build check..."
    if ! go build -v ./...; then
        echo "âŒ Build failed. Push aborted."
        exit 1
    fi
    echo "âœ… Build passed!"
    
    echo "ğŸ‰ All checks passed! Proceeding with push to '$protected_branch'."
else
    echo "â„¹ï¸ Not pushing to main - skipping comprehensive checks"
fi
